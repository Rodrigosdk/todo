name: Flutter CI

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
      - 'feature/**'

jobs:
  flutter-ci:
    name: Verificar cÃ³digo Flutter
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do repositÃ³rio
        uses: actions/checkout@v3

      - name: ğŸ’¾ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.x'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: flutter pub get

      - name: ğŸ¯ AnÃ¡lise estÃ¡tica
        run: flutter analyze

      - name: ğŸ§ª Rodar testes com cobertura
        run: flutter test --coverage

      - name: âœ… Validar cobertura mÃ­nima (70%)
        if: |
          startsWith(github.ref, 'refs/heads/main') ||
          startsWith(github.ref, 'refs/heads/develop') ||
          startsWith(github.ref, 'refs/heads/release/') ||
          startsWith(github.ref, 'refs/heads/hotfix/')
        run: |
          lf=$(grep -o 'LF:[0-9]\+' coverage/lcov.info | cut -d':' -f2 | paste -sd+ - | bc)
          lh=$(grep -o 'LH:[0-9]\+' coverage/lcov.info | cut -d':' -f2 | paste -sd+ - | bc)
          
          if [ "$lf" -eq 0 ]; then
            echo "âŒ Nenhuma linha encontrada no relatÃ³rio de cobertura. Certifique-se de que os testes estÃ£o gerando cobertura corretamente."
            exit 1
          fi
          
          coverage=$(awk "BEGIN { printf \"%.2f\", ($lh / $lf) * 100 }")
          echo "Cobertura atual: $coverage%"
          
          threshold=70
          awk -v cov=$coverage -v th=$threshold \
            'BEGIN { if (cov < th) { print "âŒ Cobertura abaixo do mÃ­nimo exigido (" th "%)"; exit 1 } else { print "âœ… Cobertura suficiente" } }'
